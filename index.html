<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ROI Legal Ops Easyjur - 1 ano (BPO de Petições)</title>
<style>
/* ====== Marca Easyjur ====== */
:root {
    --ej-primary: #e5293f; /* vermelho */
    --ej-gray-1: #acbac2; /* cinza claro */
    --ej-gray-2: #7f919a; /* cinza médio */
    --ej-blue: #007bff; /* azul para o investimento */
    --ej-white: #ffffff;
    --ej-black: #111;
    --ej-green: #28a745; /* verde para vantagem */
    --ej-red: #dc3545; /* vermelho para desvantagem */
    --ej-gold: #ffc107; /* Amarelo/Dourado para linha Advogado */
}

/* Fonte Borna: troque o src abaixo para o caminho do seu arquivo WOFF2 */
@font-face {
    font-family: 'Borna';
    src: url('Borna.woff2') format('woff2'); /* substitua pelo caminho real */
    font-weight: 400;
    font-style: normal;
    font-display: swap;
}

/* ====== Layout ====== */
html, body { height: 100%; }
body { margin: 0; background: var(--ej-white); color: var(--ej-black); font-family: 'Borna', Arial, Helvetica, sans-serif; }
.wrap { 
    max-width: 1080px; 
    margin: 0 auto; 
    padding: 24px 16px; 
    position: relative; 
}

/* Estilo para o logo */
.logo {
    display: block;
    margin: 0 auto 24px;
    max-width: 250px;
    height: auto;
}
/* Estilo para o título centralizado */
.title {
    text-align: center;
    margin: 0 0 14px;
    font-size: 22px;
    color: var(--ej-black);
}

.panel { background: var(--ej-white); border: 1px solid var(--ej-gray-1); border-radius: 14px; padding: 16px; }

/* Container de colunas com Flexbox para as seções de input */
.column-container {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
}

/* Cada coluna com seus inputs */
.input-column {
    display: flex;
    flex-direction: column;
    flex: 1 1 220px; /* Base de 220px para garantir espaço */
    border-right: 1px solid var(--ej-gray-1); /* Separador entre colunas */
    padding-right: 12px;
}

.input-column:last-of-type {
    border-right: none;
    padding-right: 0;
}

.input-box {
    padding-bottom: 12px;
    margin-bottom: 12px;
    position: relative; /* Adicionado para posicionar o ícone de info */
}

/* Títulos dos grupos */
.group-title {
    margin: 0 0 10px;
    font-size: 16px;
    color: var(--ej-gray-2);
    width: 100%;
}

label { font-size: 12px; color: #35424a; display: block; margin: 0 0 6px; }
input, select { width: 45%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--ej-gray-1); background: var(--ej-white); color: var(--ej-black); }
input:focus, select:focus { outline: none; border-color: var(--ej-primary); box-shadow: 0 0 0 2px rgba(229, 41, 63, .15); }

.row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 12px; }
button { padding: 10px 14px; border-radius: 10px; border: 1px solid transparent; cursor: pointer; font-weight: 700; }
.primary { background: var(--ej-primary); color: var(--ej-white); }
.ghost { background: transparent; color: var(--ej-black); border-color: var(--ej-gray-2); }
.success { background: var(--ej-green); color: var(--ej-white); } /* Novo estilo para a comparação */
.warning { background: var(--ej-red); color: var(--ej-white); } /* Novo estilo para a comparação */

.legend { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; font-size: 12px; color: #333; margin-top: 8px; }
.sw { width: 14px; height: 3px; border-radius: 2px; display: inline-block; margin-right: 6px; vertical-align: middle; }
.sw.eff { background: var(--ej-gray-2); }
.sw.rev { background: var(--ej-primary); }
.sw.inv { background: var(--ej-blue); }
.sw.eff_adv { background: var(--ej-gold); } /* Nova Legenda: Produção Advogado */
.sw.roi {
    width: 14px;
    height: 0;
    border-bottom: 2px dashed var(--ej-primary);
    display: inline-block;
    margin-right: 6px;
    vertical-align: middle;
}

canvas { width: 100%; height: 420px; background: #fafbfc; border: 1px solid var(--ej-gray-1); border-radius: 12px; margin-top: 10px; cursor: crosshair; }

.kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-top: 12px; }
.kpi { 
    background: #fafbfc; 
    border: 1px solid var(--ej-gray-1); 
    border-radius: 10px; 
    padding: 12px; 
    position: relative; /* Adicionado para o posicionamento do ícone */
}
.kpi .l { font-size: 12px; color: #35424a; }
.kpi .v { font-size: 20px; font-weight: 800; margin-top: 6px; color: var(--ej-black); }
.kpi .v.inv { color: var(--ej-blue); }

/* Estilo para os ícones de informação */
.info-icon {
    font-family: Arial, sans-serif; /* Fonte para o "i" */
    font-size: 12px;
    font-weight: bold;
    color: var(--ej-gray-2);
    cursor: pointer;
    margin-left: 4px;
    position: absolute;
    right: 12px;
    top: 12px;
    line-height: 1; /* Para evitar espaçamento extra */
}
.input-box .info-icon {
    top: 12px;
}

/* Estilo para o tooltip de informação */
.info-tooltip {
    visibility: hidden;
    width: 200px;
    background-color: rgba(0, 0, 0, 0.8);
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 8px;
    position: absolute;
    z-index: 10;
    bottom: 120%;
    left: 50%;
    margin-left: -100px;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
    line-height: 1.4;
}

.info-tooltip::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
}

.kpi:hover .info-tooltip,
.input-box:hover .info-tooltip {
    visibility: visible;
    opacity: 1;
}

/* Estilo para a tela expansiva*/
.accordion {
    background-color: #f5f5f5;
    color: #444;
    cursor: pointer;
    padding: 18px;
    width: 100%;
    border: none;
    text-align: left;
    outline: none;
    font-size: 15px;
    transition: 0.4s;
    border-radius: 10px;
    margin-top: 12px;
}

.active, .accordion:hover {
    background-color: #ddd;
}

.accordion:after {
    content: '\25BC'; /* Caractere de triângulo para baixo */
    color: #777;
    font-weight: bold;
    float: right;
    margin-left: 5px;
}

.active:after {
    content: "\25B2"; /* Caractere de triângulo para cima */
}

.panel-formulas {
    padding: 0 18px;
    background-color: white;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.2s ease-out;
}

.panel-formulas pre {
    white-space: pre-wrap;
    word-wrap: break-word;
}

/* Tooltip do gráfico */
#tooltip {
    position: fixed; /* Alterado para fixo para seguir o mouse na tela */
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 8px;
    border-radius: 4px;
    font-size: 12px;
    pointer-events: none;
    display: none;
    z-index: 10;
}

/* Área de comparação */
#comparison_output {
    margin-top: 20px;
    padding: 15px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 700;
    text-align: center;
}

#comparison_output.advantage {
    background-color: var(--ej-green);
    color: var(--ej-white);
}

#comparison_output.disadvantage {
    background-color: var(--ej-red);
    color: var(--ej-white);
}
</style>
</head>
<body>
<div class="wrap">
<img src="logo-easyjur-01.png" alt="Logo Easyjur" class="logo" />
<h1 class="title">ROI Legal Ops Easyjur - BPO de Petições</h1>
<div class="panel">
<div class="column-container">

<div class="input-column">
<h2 class="group-title">Investimento (BPO)</h2>
<div class="input-box">
<label>Custo mensal BPO (R$)</label>
<input id="cost_monthly" type="number" value="5000">
</div>
<div class="input-box">
<label>Consultoria Estratégica (R$)</label>
<input id="cost_onetime" type="number" value="0">
</div>
<div class="input-box">
<label>Tempo de Ativação BPO (dias)</label>
<input id="activation_bpo_days" type="number" value="30">
<div class="info-icon">
    i
    <span class="info-tooltip">
        O tempo (em dias) que leva para o BPO de Legal Ops começar a entregar a produtividade máxima.
    </span>
</div>
</div>
</div>

<div class="input-column">
<h2 class="group-title">Eficiência (Produção BPO)</h2>
<div class="input-box">
<label>Valor/hora Advogado (R$)</label>
<input id="hour_rate_advogado" type="number" value="120">
</div>
<div class="input-box">
<label>Horas gastas para criar uma petição</label>
<input id="hours_per_petition" type="number" value="2">
</div>
<div class="input-box">
<label>Quantidade de petições por mês</label>
<input id="petitions_per_month" type="number" value="50">
</div>
</div>

<div class="input-column">
<h2 class="group-title">Ganho de Faturamento</h2>
<div class="input-box">
<label>Contratos/mês (Novos)</label>
<input id="contracts_month" type="number" value="3">
</div>
<div class="input-box">
<label>Ticket médio (R$)</label>
<input id="ticket" type="number" value="2500">
</div>
<div class="input-box">
<label>Receita preservada/mês (R$)</label>
<input id="retained_revenue_month" type="number" value="2000">
</div>
</div>

<div class="input-column">
<h2 class="group-title">Custo Advogado (Comparação)</h2>
<div class="input-box">
<label>Custo mensal Advogado (R$)</label>
<input id="cost_monthly_advogado" type="number" value="8000">
</div>
<div class="input-box">
<label>Custo de Contratação Único (R$)</label>
<input id="cost_onetime_advogado" type="number" value="5000">
</div>
<div class="input-box">
<label>Tempo de Ativação Advogado (dias)</label>
<input id="activation_advogado_days" type="number" value="90">
<div class="info-icon">
    i
    <span class="info-tooltip">
        O tempo (em dias) que leva para um novo Advogado Associado estar totalmente produtivo na equipe.
    </span>
</div>
</div>
<div class="input-box">
    <label>Rampa de Ganho</label>
    <select id="ramp_shape">
        <option value="s">Curva em S</option>
        <option value="linear">Linear</option>
        <option value="stairs">Degraus</option>
    </select>
</div>
</div>

</div>

<div class="row">
<button id="calc" class="primary" type="button">Calcular ROI</button>
<button id="compare_advogado" class="ghost" type="button">Comparar Custo BPO vs Advogado</button>
<button id="csv" class="ghost" type="button">Baixar CSV</button>
</div>

<div class="row" style="margin-top: 20px; align-items: flex-start; gap: 16px;">
    <h3 class="group-title" style="margin-top: 0; margin-bottom: 0; flex: 1 1 100%;">Controles do Gráfico</h3>
    <label style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="check_inv" checked> Investimento</label>
    <label style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="check_rev" checked> Faturamento BPO</label>
    <label style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="check_eff" checked> Eficiência BPO</label>
    <label style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="check_advogado" checked> Produção Advogado</label>
    <label style="display: flex; align-items: center; gap: 4px;"><input type="checkbox" id="check_roi" checked> ROI Total</label>
</div>

<div id="comparison_output" style="display: none;"></div>

<div class="legend">
<span><span class="sw inv"></span>Investimento (acum.)</span>
<span><span class="sw rev"></span>Faturamento BPO (acum.)</span>
<span><span class="sw eff"></span>Eficiência BPO (acum.)</span>
<span><span class="sw eff_adv"></span>Produção Advogado (acum.)</span>
<span><span class="sw roi"></span>ROI Total (x)</span>
</div>

<canvas id="chart"></canvas>
<div id="tooltip"></div>

<div class="kpis">
    <div class="kpi">
        <div class="l">Investimento BPO (365d)</div>
        <div class="v" id="k_inv">—</div>
        <div class="info-icon">
            i
            <span class="info-tooltip">
                Valor total investido no BPO de Legal Ops ao longo de 1 ano.
            </span>
        </div>
    </div>
    <div class="kpi">
        <div class="l">Retorno Faturamento (365d)</div>
        <div class="v" id="k_rev">—</div>
        <div class="info-icon">
            i
            <span class="info-tooltip">
                Ganho acumulado em faturamento (novos contratos + receita preservada).
            </span>
        </div>
    </div>
    <div class="kpi">
        <div class="l">Retorno Eficiência (365d)</div>
        <div class="v" id="k_eff">—</div>
        <div class="info-icon">
            i
            <span class="info-tooltip">
                Ganho acumulado em valor financeiro pela otimização da produção de petições.
            </span>
        </div>
    </div>
    <div class="kpi">
        <div class="l">ROI Total (365d)</div>
        <div class="v" id="k_roi">—</div>
        <div class="info-icon">
            i
            <span class="info-tooltip">
                O Retorno sobre o Investimento do BPO.
            </span>
        </div>
    </div>
    <div class="kpi" style="background: var(--ej-green); color: var(--ej-white); border-color: var(--ej-green);">
        <div class="l" style="color: var(--ej-white);">Vantagem BPO (x)</div>
        <div class="v" id="k_vantagem" style="color: var(--ej-white);">—</div>
        <div class="info-icon" style="color: var(--ej-white);">
            i
            <span class="info-tooltip" style="color: var(--ej-black); background-color: var(--ej-white);">
                Compara o Retorno Líquido (Ganho - Custo) do BPO vs. o Retorno Líquido do Advogado.
            </span>
        </div>
    </div>
</div>

</div>

<button class="accordion">Fórmulas para o Cálculo do ROI</button>
<div class="panel-formulas">
<pre>
Fórmulas de Cálculo (BPO de Petições)

Valor de Produção da Petição = Valor/hora Advogado * Horas Gastas para Criar uma Petição

Ganho por Eficiência Diário (BPO):
Ganho Diário = (Valor de Produção da Petição * Petições por Mês / 30) * Rampa (BPO)

Ganho por Eficiência Diário (Advogado):
Ganho Diário = (Valor de Produção da Petição * Petições por Mês / 30) * Rampa (Advogado)

Ganho de Faturamento Diário (BPO e Advogado):
Ganho Diário = (Contratos Mensais * Ticket Médio + Receita Preservada Mensal) / 30 * Rampa (BPO ou Advogado)

Custo Diário (Investimento BPO):
Custo Diário = (Custo Mensal BPO / 30) + (Custo Implementação Única BPO / 90)

Custo Total Advogado (1 Ano - Incluindo Ativação):
Custo Anual Advogado = (Custo Mensal Advogado * 12) + Custo de Contratação Única 
                       + (Custo Mensal Advogado * Tempo de Ativação Advogado / 30)
                       * (0.5) // Assumindo 50% de custo de improdutividade na ativação

Retorno Líquido:
Retorno Líquido = (Eficiência Acumulada + Faturamento Acumulada) - Investimento Acumulado

Vantagem BPO (x):
Vantagem X = Retorno Líquido BPO / Retorno Líquido Advogado
</pre>
</div>
</div>

<script>
(function(){
function byId(id){ return document.getElementById(id); }

var canvas = byId('chart');
var ctx = canvas.getContext('2d');
var tooltip = byId('tooltip');
var comparisonOutput = byId('comparison_output');
var DAYS = 365; // período de 1 ano
var data = null; // para armazenar os dados calculados

function fixCanvas(){
    var dpr = Math.max(1, window.devicePixelRatio || 1);
    var rect = canvas.getBoundingClientRect();
    var W = rect.width || 1000, H = 420;
    canvas.width = Math.round(W * dpr);
    canvas.height = Math.round(H * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    return { W: W, H: H };
}

/**
 * Calcula a curva de rampa. 
 */
function ramp(shape, n, startDay){
    var rampDays = 90; // Duração da subida da rampa em 90 dias
    var arr = new Array(n); for(var i = 0; i < n; i++) arr[i] = 0;
    // O startDay aqui é o ponto onde a rampa *começa* a subir.
    var s = Math.max(1, Math.min(n, startDay || 1)) - 1;
    var e = Math.min(n - 1, s + rampDays - 1);
    
    for(var j = 0; j < n; j++){
        if(j < s){ arr[j] = 0; continue; }
        if(j > e){ arr[j] = 1; continue; }
        var t = (j - s) / Math.max(1, (e - s));
        var r = 0;
        if(shape === 'linear'){ r = Math.max(0, Math.min(1, t)); }
        else if(shape === 'stairs'){ r = (t < 1/3) ? 0.33 : (t < 2/3 ? 0.66 : 1); }
        else { var k = 8, x = (t - 0.5) * k; var u = 1 / (1 + Math.exp(-x)); var r0 = 1 / (1 + Math.exp(k / 2)); var r1 = 1 / (1 + Math.exp(-k / 2)); r = (u - r0) / (r1 - r0); if(r < 0) r = 0; if(r > 1) r = 1; }
        arr[j] = r;
    }
    return arr;
}

function compute(){
    // Entradas BPO / Investimento
    var costMonthlyBPO = Number(byId('cost_monthly').value) || 0;
    var costOnetimeBPO = Number(byId('cost_onetime').value) || 0;
    var activationBPODays = Number(byId('activation_bpo_days').value) || 30;
    
    // Entradas Advogado (usadas na comparação)
    var costMonthlyAdvogado = Number(byId('cost_monthly_advogado').value) || 0;
    var costOnetimeAdvogado = Number(byId('cost_onetime_advogado').value) || 0;
    var activationAdvogadoDays = Number(byId('activation_advogado_days').value) || 90;
    
    // Entradas Eficiência / Faturamento
    var hourRateAdvogado = Number(byId('hour_rate_advogado').value) || 0;
    var hoursPerPetition = Number(byId('hours_per_petition').value) || 0;
    var petitionsPerMonth = Number(byId('petitions_per_month').value) || 0;
    var contracts = Number(byId('contracts_month').value) || 0;
    var ticket = Number(byId('ticket').value) || 0;
    var retained = Number(byId('retained_revenue_month').value) || 0;
    var shape = byId('ramp_shape').value;

    // RAMPA BPO e ADVOGADO
    var rr_bpo = ramp(shape, DAYS, activationBPODays); 
    var rr_advogado = ramp(shape, DAYS, activationAdvogadoDays);

    // CÁLCULO DE BASE DIÁRIA (Valores máximos no dia 365)
    var dailyEffBase = 0;
    if (hoursPerPetition > 0) {
        var valuePerPetition = hourRateAdvogado * hoursPerPetition;
        dailyEffBase = (valuePerPetition * petitionsPerMonth) / 30;
    }
    var dailyRevBase = (contracts * ticket) / 30 + (retained / 30);
    var dailyInv = (costMonthlyBPO / 30) + (costOnetimeBPO / 90);

    var cE = 0, cR = 0, cI = 0, cumEff = [], cumRev = [], cumInv = [], cumROI = [];
    var cEA = 0, cRA = 0, cumEffAdvogado = [], cumRevAdvogado = []; // Acumuladores Advogado

    for(var i = 0; i < DAYS; i++){
        // Valores BPO (Cálculo principal do ROI)
        cE += rr_bpo[i] * dailyEffBase; // Rampa BPO para Eficiência
        cR += rr_bpo[i] * dailyRevBase; // Rampa BPO para Faturamento
        cI += dailyInv;
        
        // Valores Advogado (Cálculo de comparação e nova linha)
        cEA += rr_advogado[i] * dailyEffBase; // Rampa Advogado para Eficiência (Produção)
        cRA += rr_advogado[i] * dailyRevBase; // Rampa Advogado para Faturamento
        
        cumEff.push(cE); cumRev.push(cR); cumInv.push(cI);
        cumROI.push(cI > 0 ? (cE + cR - cI) / cI : 0);
        cumEffAdvogado.push(cEA);
        cumRevAdvogado.push(cRA);
    }
    
    // CUSTO TOTAL ADVOGADO (1 ano)
    var costTotalAdvogado = costMonthlyAdvogado * 12 + costOnetimeAdvogado;
    // Adiciona o custo do salário pago durante o período de ativação (assumindo 50% de improdutividade)
    var costRampAdvogado = (costMonthlyAdvogado / 30) * activationAdvogadoDays * 0.5;
    costTotalAdvogado += costRampAdvogado;
    
    // Cálculo da Vantagem (X)
    var retornoLiquidoBPO = (cE + cR) - cI;
    var retornoLiquidoAdvogado = (cEA + cRA) - costTotalAdvogado;
    var vantagemX = 0;
    if (retornoLiquidoAdvogado > 0) {
        // BPO é mais vantajoso (ou menos desvantajoso)
        vantagemX = retornoLiquidoBPO / retornoLiquidoAdvogado;
    } else if (retornoLiquidoBPO > 0) {
        // BPO lucrativo, Advogado não lucrativo.
        vantagemX = Infinity; // Representa uma vantagem "infinita"
    } else if (retornoLiquidoBPO < 0 && retornoLiquidoAdvogado < 0) {
        // Ambos dão prejuízo, mas o menor prejuízo é o "menos desvantajoso"
        vantagemX = retornoLiquidoBPO / retornoLiquidoAdvogado;
    }


    return {
        cumEff: cumEff,
        cumRev: cumRev,
        cumInv: cumInv,
        cumROI: cumROI,
        cumEffAdvogado: cumEffAdvogado, // Novo array para plotagem
        
        totals: {
            eff: cE,
            rev: cR,
            inv: cI,
            roi: (cI > 0 ? (cE + cR - cI) / cI : 0),
            advogado_anual: costTotalAdvogado, 
            eff_advogado: cEA,
            rev_advogado: cRA,
            vantagem_x: vantagemX
        }
    };
}

function draw(){
    var dims = fixCanvas(); var W = dims.W, H = dims.H;
    data = compute();

    // Leitura dos Checkboxes
    var checkInv = byId('check_inv').checked;
    var checkRev = byId('check_rev').checked;
    var checkEff = byId('check_eff').checked;
    var checkAdvogado = byId('check_advogado').checked;
    var checkRoi = byId('check_roi').checked;


    ctx.clearRect(0, 0, W, H);
    var pad = { l: 60, r: 60, t: 24, b: 40 };
    function X(i){ return pad.l + (i / (DAYS - 1)) * (W - pad.l - pad.r); }

    // escalas - O MAXIMO M deve considerar todas as linhas monetárias
    var M = 1; 
    for(var i = 0; i < DAYS; i++){ 
        if(checkEff && data.cumEff[i] > M) M = data.cumEff[i]; 
        if(checkRev && data.cumRev[i] > M) M = data.cumRev[i]; 
        if(checkInv && data.cumInv[i] > M) M = data.cumInv[i]; 
        if(checkAdvogado && data.cumEffAdvogado[i] > M) M = data.cumEffAdvogado[i]; 
    }
    
    function Ym(v){ return pad.t + (1 - (v / M)) * (H - pad.t - pad.b); }
    
    var roiMax = 0.01, roiMin = 0; 
    if(checkRoi){ for(var j = 0; j < DAYS; j++){ var rv = data.cumROI[j]; if(rv > roiMax) roiMax = rv; if(rv < roiMin) roiMin = rv; } }
    
    function Yr(v){ var rng = (roiMax - roiMin) || 1; return pad.t + (1 - ((v - roiMin) / rng)) * (H - pad.t - pad.b); }

    // grade
    ctx.strokeStyle = '#e5eaee'; ctx.lineWidth = 1; ctx.beginPath();
    for(var gi = 0; gi <= 5; gi++){ var gy = pad.t + gi * (H - pad.t - pad.b) / 5; ctx.moveTo(pad.l, gy); ctx.lineTo(W - pad.r, gy); }
    ctx.stroke();

    // rótulos do eixo X por mês: M1..M12 (aprox. cada 30 dias)
    ctx.fillStyle = '#333'; ctx.font = '12px Borna, Arial';
    for(var d = 0, m = 1; d < DAYS; d += 30, m++){ var xx = X(d); ctx.fillText('M' + m, xx - 8, H - 12); }

    // marcadores de impacto (90, 180, 270, 360)
    var impacts = [90, 180, 270, 360];
    ctx.save(); ctx.setLineDash([6, 6]); ctx.strokeStyle = '#cfd7db';
    for(var mi = 0; mi < impacts.length; mi++){
        var day = impacts[mi] - 1; if(day < 0 || day >= DAYS) continue; var xx = X(day);
        ctx.beginPath(); ctx.moveTo(xx, pad.t); ctx.lineTo(xx, H - pad.b); ctx.stroke();
        ctx.fillStyle = '#7f919a';
        ctx.beginPath(); ctx.moveTo(xx, pad.t + 2); ctx.lineTo(xx - 6, pad.t + 14); ctx.lineTo(xx + 6, pad.t + 14); ctx.closePath(); ctx.fill();
        ctx.fillStyle = '#111'; ctx.font = '12px Borna, Arial';
        ctx.fillText((mi + 1) + 'º Impacto', xx + 8, pad.t + 16);
    }
    ctx.restore();

    // linhas
    function line(arr, y){ ctx.beginPath(); for(var k = 0; k < arr.length; k++){ var xx = X(k), yy = y(arr[k]); if(k === 0) ctx.moveTo(xx, yy); else ctx.lineTo(xx, yy); } ctx.stroke(); }

    // Desenho Condicional das Linhas
    ctx.lineWidth = 2;
    
    // 1. Eficiência BPO (Ganho)
    if(checkEff){
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ej-gray-2') || '#7f919a';
        line(data.cumEff, Ym);
    }

    // 2. Faturamento BPO (Ganho)
    if(checkRev){
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ej-primary') || '#e5293f';
        line(data.cumRev, Ym);
    }

    // 3. Investimento BPO (Custo)
    if(checkInv){
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ej-blue') || '#007bff';
        line(data.cumInv, Ym);
    }

    // 4. Produção Advogado (Nova Linha de Faturamento/Eficiência do Advogado)
    if(checkAdvogado){
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ej-gold') || '#ffc107';
        line(data.cumEffAdvogado, Ym);
    }

    // 5. ROI (trilhado)
    if(checkRoi){
        ctx.setLineDash([4, 4]); 
        ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ej-primary') || '#e5293f';
        line(data.cumROI, Yr); 
        ctx.setLineDash([]);
    }

    // rótulos dos eixos Y
    ctx.fillStyle = '#333'; ctx.font = '12px Borna, Arial';
    // Eixo Y Esquerdo (Monetário)
    for(var gy = 0; gy <= 5; gy++){
        var v = M * (1 - gy / 5); var ly = pad.t + gy * (H - pad.t - pad.b) / 5; var txt = v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL', maximumFractionDigits: 0});
        ctx.fillText(txt, 8, ly + 4);
    }
    // Eixo Y Direito (ROI)
    if(checkRoi){
        for(var gr = 0; gr <= 5; gr++){
            var v2 = roiMin + (roiMax - roiMin) * (1 - gr / 5); var ly2 = pad.t + gr * (H - pad.t - pad.b) / 5;
            var txt2 = (v2*100).toFixed(0) + '%';
            if (v2 > 0) txt2 = v2.toFixed(1) + 'x';
            if (v2 <= 0) txt2 = '0x';
            ctx.fillText(txt2, W - 44, ly2 + 4);
        }
    }

    // KPIs
    function BRL(v){ return v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'}); }
    
    // BPO KPIs
    if (data.totals.roi <= 0.01) { byId('k_roi').textContent = '0x'; } else { byId('k_roi').textContent = data.totals.roi.toFixed(1) + 'x'; }
    byId('k_eff').textContent = BRL(data.totals.eff);
    byId('k_rev').textContent = BRL(data.totals.rev);
    byId('k_inv').textContent = BRL(data.totals.inv);
    byId('k_inv').classList.add('inv');

    // Novo KPI de Vantagem
    var vantagemX = data.totals.vantagem_x;
    if (vantagemX === Infinity) {
        byId('k_vantagem').textContent = 'Infinito';
    } else if (vantagemX > 0) {
        byId('k_vantagem').textContent = vantagemX.toFixed(1) + 'x';
    } else {
        byId('k_vantagem').textContent = '0x';
    }
}

function downloadCsv(){
    var d = compute();
    var lines = ['dia,mes_index,eff_bpo_acum,rev_bpo_acum,eff_adv_acum,rev_adv_acum,beneficio_bpo_acum,invest_bpo_acum,roi_bpo'];
    for(var i = 0; i < DAYS; i++){
        var ce_bpo = d.cumEff[i], cr_bpo = d.cumRev[i], ci_bpo = d.cumInv[i]; 
        var ce_adv = d.cumEffAdvogado[i], cr_adv = d.cumRevAdvogado[i];
        var cb_bpo = ce_bpo + cr_bpo, roi = d.cumROI[i];
        var m = Math.floor(i / 30) + 1;
        lines.push([i + 1, m, ce_bpo.toFixed(2), cr_bpo.toFixed(2), ce_adv.toFixed(2), cr_adv.toFixed(2), cb_bpo.toFixed(2), ci_bpo.toFixed(2), roi.toFixed(6)].join(','));
    }
    var csv = lines.join('\r\n');
    var blob = null; try{ blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8' }); } catch(e){ blob = null; }
    var url = blob ? URL.createObjectURL(blob) : 'data:text/csv;charset=utf-8,' + encodeURIComponent('\uFEFF' + csv);
    var a = document.createElement('a'); a.href = url; a.download = 'roi_legalops_bpo_1ano.csv'; document.body.appendChild(a); a.click(); a.remove(); if(blob && URL && URL.revokeObjectURL) URL.revokeObjectURL(url);
}

function compareCosts(){
    var data = compute(); // Recalcula para garantir dados atualizados
    
    // Entradas BPO
    var costMonthlyBPO = Number(byId('cost_monthly').value) || 0;
    var costOnetimeBPO = Number(byId('cost_onetime').value) || 0;
    var costTotalBPO = costMonthlyBPO * 12 + costOnetimeBPO;

    // Custo Advogado (já calculado com o custo de ativação na função compute)
    var costTotalAdvogado = data.totals.advogado_anual; 
    
    // Formatação
    function BRL(v){ return v.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL', maximumFractionDigits: 2}); }

    // Comparação
    var diff = costTotalAdvogado - costTotalBPO;
    comparisonOutput.style.display = 'block';

    if (diff > 0) {
        // BPO mais barato
        comparisonOutput.className = 'advantage';
        comparisonOutput.innerHTML = `**VANTAGEM CUSTO:** O BPO de Legal Ops é **${BRL(diff)}** mais barato em 1 ano que a contratação de um Advogado Associado (considerando a ativação e custos anuais).`;
    } else if (diff < 0) {
        // Advogado mais barato (ou BPO mais caro)
        comparisonOutput.className = 'disadvantage';
        comparisonOutput.innerHTML = `**DESVANTAGEM CUSTO:** O BPO de Legal Ops é **${BRL(Math.abs(diff))}** mais caro em 1 ano que a contratação de um Advogado Associado (considerando a ativação e custos anuais).`;
    } else {
        // Custos iguais
        comparisonOutput.className = '';
        comparisonOutput.style.backgroundColor = 'var(--ej-gray-1)';
        comparisonOutput.innerHTML = `**CUSTOS EQUIVALENTES:** O custo anual do BPO é o mesmo que o da contratação do Advogado Associado: ${BRL(costTotalBPO)}.`;
    }
}

// Lógica do Tooltip
function showTooltip(e) {
    if (!data) return;
    var rect = canvas.getBoundingClientRect();
    var x = e.clientX - rect.left;
    var y = e.clientY - rect.top;
    var pad = { l: 60, r: 60, t: 24, b: 40 };

    if (x < pad.l || x > (rect.width - pad.r) || y < pad.t || y > (rect.height - pad.b)) {
        tooltip.style.display = 'none';
        return;
    }

    var i = Math.round((x - pad.l) / (rect.width - pad.l - pad.r) * (DAYS - 1));
    if (i < 0 || i >= DAYS) {
        tooltip.style.display = 'none';
        return;
    }

    var day = i + 1;
    var eff = data.cumEff[i].toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 });
    var rev = data.cumRev[i].toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 });
    var inv = data.cumInv[i].toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 });
    var roi = data.cumROI[i] > 0.01 ? data.cumROI[i].toFixed(1) + 'x' : '0x';
    var eff_adv = data.cumEffAdvogado[i].toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits: 0 });


    tooltip.innerHTML = `Dia ${day}<br>Inv. BPO: ${inv}<br>Eficiência BPO: ${eff}<br>Prod. Advogado: ${eff_adv}<br>Faturamento: ${rev}<br>ROI: ${roi}`;
    tooltip.style.left = `${e.clientX + 10}px`;
    tooltip.style.top = `${e.clientY + 10}px`;
    tooltip.style.display = 'block';
}

function hideTooltip() {
    tooltip.style.display = 'none';
}

canvas.addEventListener('mousemove', showTooltip);
canvas.addEventListener('mouseout', hideTooltip);

// Lógica do Acordeão
var acc = document.getElementsByClassName("accordion")[0];
acc.addEventListener("click", function() {
    this.classList.toggle("active");
    var panel = this.nextElementSibling;
    if (panel.style.maxHeight) {
        panel.style.maxHeight = null;
    } else {
        panel.style.maxHeight = panel.scrollHeight + "px";
    }
});

byId('calc').addEventListener('click', draw);
byId('csv').addEventListener('click', downloadCsv);
byId('compare_advogado').addEventListener('click', compareCosts);
// Adiciona evento de redesenho aos checkboxes
byId('check_inv').addEventListener('change', draw);
byId('check_rev').addEventListener('change', draw);
byId('check_eff').addEventListener('change', draw);
byId('check_advogado').addEventListener('change', draw);
byId('check_roi').addEventListener('change', draw);

window.addEventListener('resize', draw);
draw();
})();
</script>
</body>
</html>
